!function(e){var t={};function n(a){if(t[a])return t[a].exports;var o=t[a]={i:a,l:!1,exports:{}};return e[a].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(a,o,function(t){return e[t]}.bind(null,o));return a},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=5)}([function(e,t){e.exports='<div class="card" style="width: 800px;height: 500px;">\n    <div class="card-header">WebRTChat</div>\n    <div style="display: flex;flex-direction: row;height: 100%;">\n        <div style="display: flex;flex-direction: column;height: 100%;border-right: solid #ccc thin;">\n            <div style="font-weight: bold;text-align: center;">在线列表</div>\n            <div class="list-group" style="flex: 1;width: 100%;overflow-y: auto;overflow-x: hidden;font-size: 10pt;">\n                <button v-for="c in clients" v-html="(!isMyself(c))?c:c+\' [Self]\'" :data-socketid="c"\n                        @click="socketidClickedHandler"\n                        class="list-group-item list-group-item-action">\n                </button>\n            </div>\n            <video ref="localPreview" width="240" height="180" autoplay muted></video>\n        </div>\n        <div style="flex: 1;height: 100%;position: relative;">\n            <video ref="remotePreview" style="width: 100%;height: 100%;" autoplay></video>\n            <div class="close-btn-area" v-if="remoteSocketID">\n                <span v-html="remoteSocketID"></span>\n                <button class="btn btn-danger btn-sm btn-close"\n                        @click="btnCloseCurrentSessionClicked"\n                        style="position: absolute;right: 10px;top: 10px;">\n                    <i class="fas fa-times"></i>\n                </button>\n            </div>\n        </div>\n    </div>\n</div>'},function(e,t,n){var a=n(2);"string"==typeof a&&(a=[[e.i,a,""]]);var o={insert:"head",singleton:!1};n(4)(a,o);a.locals&&(e.exports=a.locals)},function(e,t,n){(e.exports=n(3)(!1)).push([e.i,".close-btn-area {\n    position: absolute;\n    width: 100%;\n    height: 50px;\n    background-color: rgba(0, 0, 0, 0);\n    top: 0\n}\n\n.close-btn-area:hover {\n    background-color: rgba(255, 255, 255, 0.3);\n}\n\n.close-btn-area .btn-close {\n    display: none;\n}\n\n.close-btn-area:hover .btn-close {\n    display: block;\n}",""])},function(e,t,n){"use strict";e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var n=function(e,t){var n=e[1]||"",a=e[3];if(!a)return n;if(t&&"function"==typeof btoa){var o=(r=a,s=btoa(unescape(encodeURIComponent(JSON.stringify(r)))),E="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(s),"/*# ".concat(E," */")),i=a.sources.map(function(e){return"/*# sourceURL=".concat(a.sourceRoot).concat(e," */")});return[n].concat(i).concat([o]).join("\n")}var r,s,E;return[n].join("\n")}(t,e);return t[2]?"@media ".concat(t[2],"{").concat(n,"}"):n}).join("")},t.i=function(e,n){"string"==typeof e&&(e=[[null,e,""]]);for(var a={},o=0;o<this.length;o++){var i=this[o][0];null!=i&&(a[i]=!0)}for(var r=0;r<e.length;r++){var s=e[r];null!=s[0]&&a[s[0]]||(n&&!s[2]?s[2]=n:n&&(s[2]="(".concat(s[2],") and (").concat(n,")")),t.push(s))}},t}},function(e,t,n){"use strict";var a,o={},i=function(){return void 0===a&&(a=Boolean(window&&document&&document.all&&!window.atob)),a},r=function(){var e={};return function(t){if(void 0===e[t]){var n=document.querySelector(t);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}e[t]=n}return e[t]}}();function s(e,t){for(var n=[],a={},o=0;o<e.length;o++){var i=e[o],r=t.base?i[0]+t.base:i[0],s={css:i[1],media:i[2],sourceMap:i[3]};a[r]?a[r].parts.push(s):n.push(a[r]={id:r,parts:[s]})}return n}function E(e,t){for(var n=0;n<e.length;n++){var a=e[n],i=o[a.id],r=0;if(i){for(i.refs++;r<i.parts.length;r++)i.parts[r](a.parts[r]);for(;r<a.parts.length;r++)i.parts.push(T(a.parts[r],t))}else{for(var s=[];r<a.parts.length;r++)s.push(T(a.parts[r],t));o[a.id]={id:a.id,refs:1,parts:s}}}}function c(e){var t=document.createElement("style");if(void 0===e.attributes.nonce){var a=n.nc;a&&(e.attributes.nonce=a)}if(Object.keys(e.attributes).forEach(function(n){t.setAttribute(n,e.attributes[n])}),"function"==typeof e.insert)e.insert(t);else{var o=r(e.insert||"head");if(!o)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");o.appendChild(t)}return t}var _,C=(_=[],function(e,t){return _[e]=t,_.filter(Boolean).join("\n")});function l(e,t,n,a){var o=n?"":a.css;if(e.styleSheet)e.styleSheet.cssText=C(t,o);else{var i=document.createTextNode(o),r=e.childNodes;r[t]&&e.removeChild(r[t]),r.length?e.insertBefore(i,r[t]):e.appendChild(i)}}function d(e,t,n){var a=n.css,o=n.media,i=n.sourceMap;if(o&&e.setAttribute("media",o),i&&btoa&&(a+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(i))))," */")),e.styleSheet)e.styleSheet.cssText=a;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(a))}}var p=null,S=0;function T(e,t){var n,a,o;if(t.singleton){var i=S++;n=p||(p=c(t)),a=l.bind(null,n,i,!1),o=l.bind(null,n,i,!0)}else n=c(t),a=d.bind(null,n,t),o=function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(n)};return a(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;a(e=t)}else o()}}e.exports=function(e,t){(t=t||{}).attributes="object"==typeof t.attributes?t.attributes:{},t.singleton||"boolean"==typeof t.singleton||(t.singleton=i());var n=s(e,t);return E(n,t),function(e){for(var a=[],i=0;i<n.length;i++){var r=n[i],c=o[r.id];c&&(c.refs--,a.push(c))}e&&E(s(e,t),t);for(var _=0;_<a.length;_++){var C=a[_];if(0===C.refs){for(var l=0;l<C.parts.length;l++)C.parts[l]();delete o[C.id]}}}}},function(e,t,n){"use strict";n.r(t);n(1);var a=n(0),o=n.n(a);var i={LIST_CLIENTS:"listClients",GOT_ANSWER_SESSION_DESCRIPTION:"gotAnswerSessionDescription",START_CHAT_SESSION:"startChatSession",GET_LOCAL_MEDIA_STREAM:"getLocalMediaStream",START_APP:"startApp",CONNECT_SOCKET:"connectSocket",SEND_OFFER_SESSION_DESCRIPTION:"sendOfferSessionDescription",SEND_ANSWER_SESSION_DESCRIPTION:"sendAnswerSessionDescription",SEND_OFFER_ICE_CANDIDATE:"SendOfferICECandidate",SEND_ANSWER_ICE_CANDIDATE:"SendAnswerICECandidate",RECEIVED_OFFER_SESSION_DESCRIPTION:"receivedOfferSessionDescription",RECEIVED_ANSWER_SESSION_DESCRIPTION:"receivedAnswerSessionDescription",RECEIVED_OFFER_ICE_CANDIDATE:"receivedOfferICECandidate",RECEIVED_ANSWER_ICE_CANDIDATE:"receivedAnswerICECandidate",GOT_REMOTE_TRACK:"gotRemoteTrack"};var r={KEY_SOCKET:"socket",KEY_CURRENT_LOCAL_SOCKET_ID:"currentLocalSocketID",KEY_CURRENT_REMOTE_SOCKET_ID:"currentRemoteSocketID",KEY_CURRENT_OFFER_RTC_CONNECTION:"currentOfferRTCConnection",KEY_CURRENT_ANSWER_RTC_CONNECTION:"currentAnswerRTCConnection",KEY_SOCKET_PROXY:"socketProxy",KEY_MEDIA_CONNECTION:"mediaConnection",KEY_VUE_APP:"vueapp",KEY_LOCAL_STREAM:"localStream",KEY_REMOTE_STREAM:"remoteStream"};var s=async function(){await appContext.fire(i.CONNECT_SOCKET),await appContext.fire(i.GET_LOCAL_MEDIA_STREAM)};var E=async function(){let e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});appContext.data(r.KEY_LOCAL_STREAM,e)},c={LIST_CLIENTS:"listClients",SEND_MESSAGE:"sendMessage"};var _={makeMessage:(e,t,n,a)=>({from:e,to:t,command:n,data:a})};var C={SEND_OFFER_SESSION_DESCRIPTION:"sendOfferSessionDescription",SEND_ANSWER_SESSION_DESCRIPTION:"sendAnswerSessionDescription",SEND_OFFER_ICE_CANDIDATE:"SendOfferICECandidate",SEND_ANSWER_ICE_CANDIDATE:"SendAnswerICECandidate"};class l{constructor(e){this._socket=e,e.on("connect",()=>appContext.data(r.KEY_CURRENT_LOCAL_SOCKET_ID,e.id)),e.on(c.SEND_MESSAGE,this.messageHandler.bind(this)),e.on(c.LIST_CLIENTS,e=>appContext.fire(i.LIST_CLIENTS,e))}sendMessage(e,t,n){console.log(`Send message[${t}] to ${e}`);let a=_.makeMessage(this.socket.id,e,t,n);this.socket.emit(c.SEND_MESSAGE,a)}messageHandler(e){if(console.log(e),e.command)switch(e.command){case C.SEND_OFFER_SESSION_DESCRIPTION:appContext.fire(i.RECEIVED_OFFER_SESSION_DESCRIPTION,e.data,e.from);break;case C.SEND_ANSWER_SESSION_DESCRIPTION:appContext.fire(i.RECEIVED_ANSWER_SESSION_DESCRIPTION,e.data);break;case C.SEND_OFFER_ICE_CANDIDATE:appContext.fire(i.RECEIVED_OFFER_ICE_CANDIDATE,e.data,e.from);break;case C.SEND_ANSWER_ICE_CANDIDATE:appContext.fire(i.RECEIVED_ANSWER_ICE_CANDIDATE,e.data,e.from)}}get socket(){return this._socket}}var d=function(){let e=io();appContext.data(r.KEY_SOCKET,e),appContext.data(r.KEY_SOCKET_PROXY,new l(e))};var p={RTC_CONFIGURATION:{iceServers:[{urls:"stun:stun.l.google.com:19302"}]}};var S=async function(e){appContext.data(r.KEY_CURRENT_REMOTE_SOCKET_ID,e);let t=new RTCPeerConnection(p.RTC_CONFIGURATION);appContext.data(r.KEY_CURRENT_OFFER_RTC_CONNECTION,t),appContext.data(r.KEY_REMOTE_STREAM,new MediaStream),t.ontrack=e=>{console.log("onTrack",e),appContext.fire(i.GOT_REMOTE_TRACK,e.track)},t.onicecandidate=t=>{console.log(t),appContext.fire(i.SEND_OFFER_ICE_CANDIDATE,t.candidate,e)},t.onnegotiationneeded=async n=>{console.log(n);let a=await t.createOffer();await t.setLocalDescription(new RTCSessionDescription(a)),appContext.fire(i.SEND_OFFER_SESSION_DESCRIPTION,a,e)};let n=appContext.data(r.KEY_LOCAL_STREAM);for(let e of n.getTracks())t.addTrack(e)};var T=function(e,t){appContext.data(r.KEY_SOCKET_PROXY).sendMessage(t,C.SEND_OFFER_SESSION_DESCRIPTION,e)};var R=async function(e,t){console.log("Received offer"),console.log(e),appContext.data(r.KEY_CURRENT_REMOTE_SOCKET_ID,t);let n=new RTCPeerConnection(p.RTC_CONFIGURATION);appContext.data(r.KEY_CURRENT_ANSWER_RTC_CONNECTION,n),appContext.data(r.KEY_REMOTE_STREAM,new MediaStream),n.ontrack=e=>{console.log("onTrack"),appContext.fire(i.GOT_REMOTE_TRACK,e.track)},n.onicecandidate=e=>{console.log(e),appContext.fire(i.SEND_ANSWER_ICE_CANDIDATE,e.candidate,t)},await n.setRemoteDescription(new RTCSessionDescription(e)),appContext.data(r.KEY_LOCAL_STREAM).getTracks().forEach(e=>n.addTrack(e));let a=await n.createAnswer();await n.setLocalDescription(new RTCSessionDescription(a)),appContext.fire(i.SEND_ANSWER_SESSION_DESCRIPTION,a,t)};var u=function(e,t){appContext.data(r.KEY_SOCKET_PROXY).sendMessage(t,C.SEND_ANSWER_SESSION_DESCRIPTION,e)};var f=async function(e){console.log("Received answer"),console.log(e);let t=appContext.data(r.KEY_CURRENT_OFFER_RTC_CONNECTION);await t.setRemoteDescription(new RTCSessionDescription(e))};var N={DATA_CHANGED:"dataChanged"};class O{constructor(){this._listeners=new Map,this._data=new Map}on(e,t){let n=this._listeners.get(e);n||(n=new Set,this._listeners.set(e,n)),n.add(t)}off(e,t=null){this._listeners.has(e)&&(t?this._listeners.get(e).delete(t):this._listeners.delete(e))}async fire(e,...t){if(this._listeners.has(e))for(let n of this._listeners.get(e).values())if(await n(...t))return!0}has(e){return this._listeners.has(e)}get listeners(){return this._listeners}dataKeys(){return this._data.keys()}data(...e){let t,n;switch(e.length){case 1:return t=e[0],this._data.get(t);case 2:t=e[0],n=e[1];let a=this._data.get(t);return a!==n&&(this._data.set(t,n),this.fire(N.DATA_CHANGED,t,n,a)),this;default:return this._data}}}var I=function(e,t){appContext.data(r.KEY_SOCKET_PROXY).sendMessage(t,C.SEND_OFFER_ICE_CANDIDATE,e)};var h=async function(e,t){if(e){let t=appContext.data(r.KEY_CURRENT_ANSWER_RTC_CONNECTION);await t.addIceCandidate(new RTCIceCandidate(e)),console.log("Add ice candidate >>>>>>>>>>>>>>>>>>>>"),console.log(e),console.log("Add ice candidate <<<<<<<<<<<<<<<<<<<<")}};var A=function(e,t){appContext.data(r.KEY_SOCKET_PROXY).sendMessage(t,C.SEND_ANSWER_ICE_CANDIDATE,e)};var D=async function(e,t){if(e){let t=appContext.data(r.KEY_CURRENT_OFFER_RTC_CONNECTION);await t.addIceCandidate(new RTCIceCandidate(e)),console.log("Add ice candidate >>>>>>>>>>>>>>>>>>>>"),console.log(e),console.log("Add ice candidate <<<<<<<<<<<<<<<<<<<<")}};var v=Vue.component("vue-app",{template:o.a,data:()=>({clients:[],remoteSocketID:null}),created(){window.appContext=new O,appContext.on(N.DATA_CHANGED,this._appContext_dataChanged.bind(this)),appContext.data(r.KEY_VUE_APP,this)},mounted(){this._asyncInit()},methods:{async _asyncInit(){this.registerGlobalEvents(),await appContext.fire(i.START_APP);let e=appContext.data(r.KEY_LOCAL_STREAM);e.getTracks().forEach(e=>console.log(e)),this.$refs.localPreview.srcObject=e},registerGlobalEvents(){appContext.on(i.LIST_CLIENTS,this.listClientsHandler.bind(this)),appContext.on(i.START_APP,s),appContext.on(i.GET_LOCAL_MEDIA_STREAM,E),appContext.on(i.CONNECT_SOCKET,d),appContext.on(i.START_CHAT_SESSION,S),appContext.on(i.SEND_OFFER_SESSION_DESCRIPTION,T),appContext.on(i.SEND_ANSWER_SESSION_DESCRIPTION,u),appContext.on(i.RECEIVED_OFFER_SESSION_DESCRIPTION,R),appContext.on(i.RECEIVED_ANSWER_SESSION_DESCRIPTION,f),appContext.on(i.SEND_OFFER_ICE_CANDIDATE,I),appContext.on(i.RECEIVED_OFFER_ICE_CANDIDATE,h),appContext.on(i.SEND_ANSWER_ICE_CANDIDATE,A),appContext.on(i.RECEIVED_ANSWER_ICE_CANDIDATE,D),appContext.on(i.GOT_REMOTE_TRACK,this._gotRemoteTrackHandler.bind(this))},listClientsHandler(e){this.clients.length=0,e.forEach(e=>this.clients.push(e))},isMyself:e=>appContext.data(r.KEY_CURRENT_LOCAL_SOCKET_ID)==e,_gotRemoteTrackHandler(e){let t=appContext.data(r.KEY_REMOTE_STREAM);t&&t.addTrack(e)},socketidClickedHandler(e){if(this.remoteSocketID)return void alert("You can not start more than one session at the same time.");let t=$(e.target).data("socketid");this.isMyself(t)?alert("You can not chat with yourself."):confirm(`Don you want to chat with ${t}?`)&&appContext.fire(i.START_CHAT_SESSION,t)},_appContext_dataChanged(e,t,n){switch(e){case r.KEY_CURRENT_REMOTE_SOCKET_ID:this.remoteSocketID=t;break;case r.KEY_CURRENT_ANSWER_RTC_CONNECTION:case r.KEY_CURRENT_OFFER_RTC_CONNECTION:n&&n.close();break;case r.KEY_REMOTE_STREAM:this.$refs.remotePreview.srcObject=t}},btnCloseCurrentSessionClicked(e){appContext.data(r.KEY_CURRENT_OFFER_RTC_CONNECTION,null),appContext.data(r.KEY_CURRENT_ANSWER_RTC_CONNECTION,null),appContext.data(r.KEY_CURRENT_REMOTE_SOCKET_ID,null)}}});document.body.appendChild((new v).$mount(document.createElement("div")).$el)}]);